# åœ¨æœ‰æ•°ç™¾ä¸‡æ¡è®°å½•çš„ç”Ÿäº§ MySql ä¸Šè¿è¡Œ ALTER TABLE

> åŸæ–‡ï¼š<https://medium.com/javarevisited/running-alter-table-on-production-mysql-with-millions-of-records-293f42b44df7?source=collection_archive---------1----------------------->

æœ‰äº›äº‹æƒ…æˆ‘ä»¬ä¸å–œæ¬¢åšï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¾—ä¸åšï¼

![](img/159db045d3d7c60fc38bfee090b8cf0b.png)

ç”±[æ³°å‹’ç»´å…‹](https://unsplash.com/@tvick?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

ç”Ÿäº§æ•°æ®åº“ä¸Šçš„æ¨¡å¼å˜æ›´ä¸€ç›´æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼Œå½“æˆ‘ä»¬è°ˆè®ºæ•°ç™¾ä¸‡æ¡è®°å½•æ—¶ï¼Œè¿™ä¸ªé—®é¢˜å°±æ›´åŠ ä¸¥é‡äº†ï¼Œå¦‚æœæ‚¨è¿‡å»åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šè¿è¡Œè¿‡å˜æ›´ï¼Œé‚£ä¹ˆæ‚¨å°±ä¼šçŸ¥é“,`ALTER TABLE`å‘½ä»¤åŸºæœ¬ä¸Šæ˜¯è¯»å–æ•´ä¸ªè¡¨çš„é”ï¼Œç„¶åçŸ­æš‚åœ°å†™å…¥é”ã€‚å¦‚æœæœ‰æ•°ç™¾ä¸‡æ¡è®°å½•ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªç®€å•çš„`ADD COLUMN`å°†éœ€è¦ 20-30 åˆ†é’Ÿï¼Œå¹¶å°†å¯¼è‡´ç”Ÿäº§åœå·¥ã€‚

> *æ³¨æ„:å¯¹äº MySQL ç‰ˆæœ¬< 5.6 é”æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ 5.6+å’Œ InnoDBï¼Œå¾ˆå¤š* [*ALTER TABLE æ“ä½œéƒ½å¯ä»¥é¿å…é”ã€‚*](https://dev.mysql.com/doc/refman/5.6/en/innodb-online-ddl-operations.html)

# **Percona å·¥å…·åŒ…æ•‘æ´åŠ©æ‰‹ğŸš€**

![](img/1e8702bb53915ad7ac855b2f510d8aab.png)

[Percona Toolkit Helper](https://www.percona.com/doc/percona-toolkit/3.0) è‡ªå¸¦***pt-online-schema-change****å…¶ä¸­çš„* [*æ–‡æ¡£*](https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html#name) *â€¦*

> pt-online-schema-change åœ¨ä¸é˜»å¡è¯»æˆ–å†™çš„æƒ…å†µä¸‹æ”¹å˜è¡¨çš„ç»“æ„ã€‚åœ¨ DSN ä¸­æŒ‡å®šæ•°æ®åº“å’Œè¡¨ã€‚åœ¨é˜…è¯»è¯¥å·¥å…·çš„æ–‡æ¡£å¹¶ä»”ç»†æ£€æŸ¥æ‚¨çš„å¤‡ä»½ä¹‹å‰ï¼Œè¯·å‹¿ä½¿ç”¨è¯¥å·¥å…·ã€‚

åŸºæœ¬ä¸Šï¼Œ**pt-online-schema-change**çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº MySql ALTER çš„å†…éƒ¨å·¥ä½œæ–¹å¼ï¼Œä½†å”¯ä¸€çš„åŒºåˆ«æ˜¯å®ƒå¤„ç†çš„æ˜¯è¦æ›´æ”¹çš„è¡¨çš„å‰¯æœ¬ã€‚ä¸‹é¢æ˜¯å®ƒåœ¨å¹•ååšçš„äº‹æƒ…:

1.  åˆ›å»ºè¦ä¿®æ”¹çš„è¡¨çš„ç©ºå‰¯æœ¬ï¼Œå¹¶æ ¹æ®éœ€è¦ä¿®æ”¹å®ƒã€‚
2.  å¤åˆ¶åŸå§‹è¡¨ä¸­çš„å†…å®¹ï¼Œå¹¶ä»åŸå§‹è¡¨ä¸­åˆ›å»ºè§¦å‘å™¨ï¼Œä»¥ä¾¿åœ¨å‘ç”Ÿä»»ä½•æ›´æ–°æ—¶æ›´æ–°æ–°è¡¨ä¸­çš„ç›¸åº”è¡Œã€‚
3.  æ•°æ®æ˜¯ä»¥å°å—çš„å½¢å¼å¤åˆ¶çš„ï¼Œè¿™å¯ä»¥æ ¹æ®ç”¨æˆ·æ¥æ§åˆ¶ï¼Œæˆ‘ä»¬ç¨åä¼šè°ˆåˆ°è¿™ä¸€ç‚¹ã€‚
4.  å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œå®ƒåŒæ—¶å¯¹åŸå§‹è¡¨å’Œæ–°è¡¨è¿›è¡ŒåŸå­é‡å‘½åï¼Œå¹¶åˆ é™¤åŸå§‹è¡¨ postã€‚

åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼ŒåŸå§‹æ•°æ®åº“æ˜¯ç©ºé—²çš„ï¼Œå¯ä»¥ä¸ºè¯»å†™æµé‡æä¾›æœåŠ¡ã€‚

# å®‰è£…æŒ‡å—

è¯·å‚è€ƒ Percona toolkit ç½‘ç«™çš„[ä¸‹è½½éƒ¨åˆ†](https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html#downloading)äº†è§£æ›´å¤šä¿¡æ¯ã€‚

```
sudo apt install percona-toolkit
wget percona.com/get/percona-toolkit.tar.gz
wget percona.com/get/percona-toolkit.rpm
wget percona.com/get/percona-toolkit.deb
```

**æ ·æœ¬ç”¨æ³•:**

```
pt-online-schema-change --host <HOST> --user <DB_USER> --ask-pass  --alter "add column <YOUR_COLUMN_NAME>" D=<DATABASE>,t=<TABLE> --execute
```

**å¼ºåˆ¶é€‰é¡¹:**

1.  **â€”ä¸»æœº:**åœ¨æ­¤æŒ‡å®šæ•°æ®åº“ä¸»æœº
2.  **â€”è¯¢é—®-é€šè¿‡:**åœ¨æ‰§è¡Œæ—¶è¯¢é—®å¯†ç æˆ–ä½¿ç”¨
    **â€”å¯†ç **:åœ¨å‘½ä»¤æœ¬èº«ä¸­è¾“å…¥å¯†ç 
3.  **â€” alter:** è¦è¿è¡Œçš„ alter å‘½ä»¤
4.  **â€” D** :æ‚¨çš„æ•°æ®åº“çš„åç§°
5.  **â€” T** :è¡¨æ ¼åç§°
6.  **â€”æ‰§è¡Œ:**ç”±äºå®‰å…¨åŸå› ï¼Œè¿™å¿…é¡»è¢«æŒ‡å®š

# **å…¶ä»–æœ‰ç”¨çš„é€‰é¡¹**

1.  **â€”æ¨¡æ‹Ÿè¿è¡Œ:**é¡¾åæ€ä¹‰ï¼Œå®ƒä¸æ‰§è¡Œ ALTER TABLEï¼Œè€Œæ˜¯æ£€æŸ¥æ‰€æœ‰å†…å®¹ï¼Œå¹¶æ£€æŸ¥è¿è¡Œå‘½ä»¤æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚æ‚¨å¯ä»¥å°†æ­¤è§†ä¸ºå¯¹æŸ¥è¯¢
    çš„æ¨¡æ‹Ÿä¿®æ”¹(è¿™ä¸èƒ½ä¸ **â€” executeã€**ä¸€èµ·ä½¿ç”¨ï¼Œä¸¤è€…æ˜¯äº’æ–¥çš„)
2.  **â€”alter-foreign-keys-method:**æ¶‰åŠå¤–é”®çš„ä¿®æ”¹æ˜¯å¾ˆæ£˜æ‰‹çš„ã€‚è¿™é‡Œå¯ç”¨çš„ä¸€äº›é€‰é¡¹æœ‰:
    **â€”rebuild _ constraints:**è¯¥æ–¹æ³•åˆ é™¤å¹¶é‡æ–°æ·»åŠ å¼•ç”¨æ–°è¡¨çš„å¤–é”®ã€‚è¿™é€šå¸¸æ˜¯é¦–é€‰ï¼Œé™¤éå­è¡¨å¤ªå¤§ï¼Œæ”¹å˜å®ƒä»¬éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚
    **drop_swap:** è¯¥é€‰é¡¹å°†ç¦ç”¨å¤–é”®æ£€æŸ¥ï¼Œç„¶ååˆ é™¤åŸå§‹è¡¨ï¼Œæ¥ç€å°†æ–°è¡¨é‡å‘½ååˆ°å®ƒçš„ä½ç½®ã€‚è¿™ç§é‡å‘½åæ“ä½œä¸æ˜¯åŸå­çš„ï¼Œå› æ­¤é£é™©æ›´å¤§ï¼Œå› ä¸ºåŸå§‹è¡¨åœ¨å¾ˆçŸ­çš„æ—¶é—´é—´éš”å†…ä¸å­˜åœ¨ï¼Œè¿™å¯èƒ½å¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚
    **auto:** è®© Percona å†³å®šä»€ä¹ˆæœ€é€‚åˆä½ çš„æ¡Œå­ã€‚
3.  **â€”æ£€æŸ¥-æ›´æ”¹:**æ£€æŸ¥æ›´æ”¹å‘½ä»¤ï¼Œå¹¶åœ¨å¯èƒ½å‡ºç°æ„å¤–è¡Œä¸ºæ—¶å‘å‡ºè­¦å‘Š
4.  **â€” check-slave-lag:** å¦‚æœå‰¯æœ¬æ»åå¤§äº **â€” max-lag** ï¼Œæš‚åœæ•°æ®å¤åˆ¶
5.  **â€”å—å¤§å°:**å®šä¹‰æ•°æ®å—çš„è¡Œæ•°ã€‚(æ•°æ®ä»¥å—çš„å½¢å¼å¤åˆ¶)
6.  **â€”ä¸´ç•Œè´Ÿè½½:**å¤åˆ¶å®Œæ¯ä¸ªå—åï¼ŒPercona ä¼šæ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœè´Ÿè½½è¿‡é«˜ï¼Œåˆ™ä¼šä¸­æ­¢ã€‚æ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ªé€—å·åˆ†éš”çš„ MySql çŠ¶æ€å˜é‡å’Œé˜ˆå€¼åˆ—è¡¨
7.  **â€”åˆ é™¤æ–°è¡¨:**æ§åˆ¶å¦‚æœæ•°æ®å¤åˆ¶å¤±è´¥ï¼Œæ˜¯å¦åˆ é™¤æ–°è¡¨
8.  **â€”åˆ é™¤æ—§è¡¨:**æ§åˆ¶æ“ä½œå®Œæˆåæ˜¯å¦è¦åˆ é™¤æ—§è¡¨
9.  **â€”æ‰“å°:**æ‰“å°å·¥å…·è§¦å‘çš„ SQL å‘½ä»¤
10.  **â€”æœ€å¤§å»¶è¿Ÿ:**å¦‚æœå‰¯æœ¬å»¶è¿Ÿè¶…è¿‡è®¾å®šå€¼ï¼Œåˆ™æš‚åœæŸ¥è¯¢
11.  **â€” max-load:** æ¯ä¸ªå—è¢«å¤åˆ¶åï¼ŒPercona æ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœè´Ÿè½½è¿‡é«˜ï¼Œæš‚åœæŸ¥è¯¢
12.  **â€”æ–°è¡¨æ ¼åç§°:**æ‚¨å¯ä»¥æŒ‡å®šæ–°è¡¨æ ¼çš„åç§°
13.  **â€” sleep:** åœ¨å¤åˆ¶æ¯ä¸ªå—ä¹‹é—´æš‚åœå¤šé•¿æ—¶é—´

# å…³äºç”¨æ³•çš„ä¸€äº›æ³¨æ„äº‹é¡¹

1.  å¦‚æœè¡¨ä¸­æ²¡æœ‰ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ï¼Œè¿™ç§æ”¹å˜å°†ä¸èµ·ä½œç”¨ã€‚
2.  é™¤éæŒ‡å®šäº† foreign key é€‰é¡¹ï¼Œå¦åˆ™ ALTER å°†ä¸é€‚ç”¨äºå¸¦æœ‰å¤–é”®çš„è¡¨ã€‚(*åœ¨é€‰é¡¹éƒ¨åˆ†å‹¾é€‰# 2)*
3.  å¦‚æœè´Ÿè½½è¿‡å¤§æˆ–æ£€æµ‹åˆ°ä»å±æ»åï¼Œè¯¥å·¥å…·ä¼šè‡ªåŠ¨æš‚åœã€‚è¿™äº›å€¼å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹æ¥æ§åˆ¶ã€‚
4.  åœ¨è¿™é‡Œè¿½è¸ªå·²çŸ¥çš„ bugsã€‘ã€‚
5.  æ ¹æ®æ–‡æ¡£ï¼Œå®ƒé€‚ç”¨äº`Percona XtraDB Cluster (PXC) 5.5.28â€“23.7`,ä½†åœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¸­ï¼Œå®ƒé€‚ç”¨äº MySQL 5.7ï¼ŒæŸ¥çœ‹ä¸‹ä¸€èŠ‚äº†è§£æ›´å¤šä¿¡æ¯ã€‚

# æµ‹è¯•æ‰§è¡Œç»“æœ

ä»¥ä¸‹æ˜¯å¯¹ç»“æœçš„ä¸€äº›è§‚å¯Ÿ:

å¦‚æœç›´æ¥åœ¨ MySql ä¸Šæ‰§è¡Œ ALTER TABLEï¼Œæ‰§è¡Œæ—¶é—´å¤§è‡´ç›¸åŒï¼Œä½†æ˜¯å¯¹åº”ç”¨ç¨‹åºè¯»/å†™æµé‡æ²¡æœ‰å½±å“ã€‚

ä»¥ä¸‹æ˜¯åœ¨**æµ‹è¯•æ•°æ®åº“**å’Œéç”Ÿäº§ç¯å¢ƒä¸‹è¿è¡Œçš„ç»“æœã€‚è¯¥è¡¨æœ‰å¤šä¸ªå¤–é”®å…³ç³»ï¼Œè®°å½•è¶…è¿‡ 500 ä¸‡æ¡ï¼Œæ€»æ‰§è¡Œæ—¶é—´å¤§çº¦ä¸º 10 åˆ†é’Ÿã€‚

ä¸‹é¢æ˜¯ç¤ºä¾‹æ‰§è¡Œè¾“å‡º

> (æ³¨æ„:ä¸ºäº†ä¿å¯†ï¼Œéšè—äº†æ•°æ®åº“å’Œè¡¨å):

```
Not checking slave lag because no slaves were found and --check-slave-lag was not specified.
Operation, tries, wait:
  analyze_table, 10, 1
  copy_rows, 10, 0.25
  create_triggers, 10, 1
  drop_triggers, 10, 1
  swap_tables, 10, 1
  update_foreign_keys, 10, 1
Child tables:
  `<DATABASE>`.`<TABLEA>` (approx. 257042 rows)
  `<DATABASE>`.`<TABLEB>` (approx. 1194 rows)
  `<DATABASE>`.`<TABLEC>` (approx. 931229 rows)
Will automatically choose the method to update foreign keys.
Altering `<DATABASE>`.`<TABLE>`...
Creating new table...
Created new table <DATABASE>._<TABLE>_new OK.
Altering new table...
Altered `<DATABASE>`.`_<TABLE>_new` OK.
2021-10-08T19:11:08 Creating triggers...
2021-10-08T19:11:08 Created triggers OK.
2021-10-08T19:11:08 Copying approximately 5564340 rows...
Copying `<DATABASE>`.`<TABLE>`:   6% 06:39 remain
Copying `<DATABASE>`.`<TABLE>`:  15% 05:39 remain
Copying `<DATABASE>`.`<TABLE>`:  23% 04:56 remain
Copying `<DATABASE>`.`<TABLE>`:  31% 04:23 remain
Copying `<DATABASE>`.`<TABLE>`:  37% 04:09 remain
Copying `<DATABASE>`.`<TABLE>`:  45% 03:34 remain
Copying `<DATABASE>`.`<TABLE>`:  53% 03:01 remain
Copying `<DATABASE>`.`<TABLE>`:  60% 02:35 remain
Copying `<DATABASE>`.`<TABLE>`:  65% 02:20 remain
Copying `<DATABASE>`.`<TABLE>`:  72% 01:52 remain
Copying `<DATABASE>`.`<TABLE>`:  80% 01:21 remain
Copying `<DATABASE>`.`<TABLE>`:  86% 00:55 remain
Copying `<DATABASE>`.`<TABLE>`:  92% 00:32 remain
Copying `<DATABASE>`.`<TABLE>`:  99% 00:02 remain
2021-10-08T19:18:19 Copied rows OK.
2021-10-08T19:18:19 Max rows for the rebuild_constraints method: 28380
Determining the method to update foreign keys...
2021-10-08T19:18:19   `<DATABASE>`.`<TABLE>`: too many rows: 257042; must use drop_swap
2021-10-08T19:18:19 Drop-swapping tables...
2021-10-08T19:18:19 Analyzing new table...
2021-10-08T19:18:19 Dropped and swapped tables OK.
Not dropping old table because --no-drop-old-table was specified.
2021-10-08T19:18:19 Dropping triggers...
2021-10-08T19:18:19 Dropped triggers OK.
Successfully altered `<DATABASE>`.`<TABLE>`.
```

**ç»“è®º**

è¯¥å·¥å…·æä¾›äº†è®¸å¤šç‰¹æ€§ï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨å¤§å‹ç”Ÿäº§è¡¨ä¸Šæ‰§è¡Œå˜æ›´ã€‚ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨è¿™ä¸ªå·¥å…·ä¹‹å‰ï¼Œåº”è¯¥æ³¨æ„ä¸€äº›å€¼å¾—æ³¨æ„çš„äº‹æƒ…ã€‚æ­¤å¤–ï¼Œæ–‡æ¡£å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œè¯¥å‘½ä»¤ä¹‹å‰ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œ[ç”Ÿäº§å¤‡ä»½](https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html#risks)å’Œæµ‹è¯•ã€‚

å¦‚æœä½ éœ€è¦æ›´å¤šçš„å¸®åŠ©ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ã€‚è¯·åŠ¡å¿…å…³æ³¨æ‰€æœ‰æ–°çš„æ›´æ–°ã€‚è°¢è°¢ä½ çš„é˜…è¯»ã€‚å¹²æ¯ğŸº